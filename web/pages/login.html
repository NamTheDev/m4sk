<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- import bootstrap 5.3.3 (CDN) css -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <!-- font awesome css (CDN) -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet">
    <title>Login</title>
</head>

<style>
</style>

<body data-bs-theme="dark" style="background-color: rgb(34, 34, 35);">
    </div>
    <div style="height: 100vh; width: 100vw; margin: 0; padding: 0;" class="align-content-center">
        <div id="loginBody" class="d-flex m-auto flex-column row-gap-5 bg-black bg-opacity-25 p-3 py-5 rounded-5"
            style="width: 60vw; max-width: 25rem;">
            <h1 class="Display-1 text-center">Login / register</h1>
            <div id="inputs" class="d-flex flex-column row-gap-3 z-0">
                <!-- full name input -->
                <div class="d-flex flex-column justify-content-center row-gap-2">
                    <div class="input-group has-validation border rounded border-0 bg-secondary bg-opacity-10">
                        <span class="input-group-text border-0 bg-transparent" id="inputIcon"><i
                                class="fa fa-user"></i></span>
                        <input type="text" id="userID" class="form-control shadow-none border-0 bg-transparent"
                            placeholder="Discord user ID" aria-describedby="inputIcon">
                        <div class="invalid-feedback bg-danger text-light text-center py-1 rounded-bottom">
                            Must be a valid Discord user ID.
                        </div>
                    </div>
                </div>
                <!-- password input -->
                <div class="d-flex flex-column justify-content-center row-gap-2">
                    <div class="input-group has-validation border rounded border-0 bg-secondary bg-opacity-10">
                        <span class="input-group-text border-0 bg-transparent" id="inputIcon"><i
                                class="fa fa-lock"></i></span>
                        <input type="password" id="password"
                            class="form-control border-0 rounded-end-0 shadow-none bg-transparent"
                            placeholder="Password" aria-describedby="inputIcon">
                        <button class="btn btn-default border-0" onclick="togglePasswordVisibility(this)">
                            <i class="fa fa-eye"></i>
                        </button>
                        <div class="invalid-feedback bg-danger text-light text-center py-1 rounded-bottom">
                            Password must be at least 8 characters long.
                        </div>
                    </div>
                </div>
                <!-- retry password input -->
                <div class="d-flex flex-column justify-content-center row-gap-2">
                    <div class="input-group has-validation border rounded border-0 bg-secondary bg-opacity-10">
                        <span class="input-group-text border-0 bg-transparent" id="inputIcon"><i
                                class="fa fa-lock"></i></span>
                        <input type="password" id="retryPassword"
                            class="form-control border-0 rounded-end-0 shadow-none bg-transparent"
                            placeholder="Re-enter Password" aria-describedby="inputIcon">
                        <button class="btn btn-default border-0" onclick="togglePasswordVisibility(this)">
                            <i class="fa fa-eye"></i>
                        </button>
                        <div class="invalid-feedback bg-danger text-light text-center py-1 rounded-bottom">
                            Passwords do not match.
                        </div>
                    </div>
                </div>
            </div>
            <!-- login button -->
            <button class="btn btn-default bg-black bg-opacity-50 border-0" id="loginButton">Login</button>
        </div>
    </div>
</body>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
    crossorigin="anonymous"></script>

<script>
    // Function to toggle password visibility
    function togglePasswordVisibility(button) {
        const icon = button.querySelector('i'); // Select the first <i> element inside the button
        const passwordInput = button.parentElement.querySelector('input'); // Find the input element within the same parent
        const isPassword = passwordInput.type === 'password'; // Check if the input type is currently 'password'

        // Toggle the input type between 'password' and 'text'
        passwordInput.type = isPassword ? 'text' : 'password';

        // Toggle the icon between 'fa-eye' and 'fa-eye-slash'
        icon.classList.toggle('fa-eye', !isPassword);
        icon.classList.toggle('fa-eye-slash', isPassword);
    }

    const User = {
        // Initialize input elements
        userID_InputElement: document.getElementById('userID'),
        password_InputElement: document.getElementById('password'),
        retryPassword_InputElement: document.getElementById('retryPassword'),
        loginButton: document.getElementById('loginButton'),
        inputsContainer: document.getElementById('inputs'),

        // Getters for input values
        get userID() {
            return this.userID_InputElement.value;
        },

        get password() {
            return this.password_InputElement.value;
        },

        get retryPassword() {
            return this.retryPassword_InputElement.value;
        },

        // Validate the user ID by sending an API request
        async validateUserID() {
            if (!this.userID || this.userID.length < 17) return false;
            const url = `./api/validate?userID=`;
            // Check if userID is a number; if not, send '@me' to the API
            const response = await fetch(/^\d+$/.test(this.userID) ? url + this.userID : url + '@me');
            return (await response.json()).response;
        },

        // Validate password length (should be more than 8 characters)
        validatePassword() {
            return this.password.length > 8;
        },

        // Validate that retry password matches the original password
        validateRetryPassword() {
            return this.retryPassword === this.password;
        },

        // Validate all inputs and handle form submission
        async validateInput() {
            // Remove 'is-invalid' class when users start typing in any input field
            for (const inputContainer of this.inputsContainer.children) {
                const input = inputContainer.querySelector('input');
                input.addEventListener('input', () => input.classList.remove('is-invalid'));
            }

            // Validate each field and mark invalid ones if they don't pass validation
            if (!await this.validateUserID()) return this.markInvalid(this.userID_InputElement.id);
            if (!this.validatePassword()) return this.markInvalid(this.password_InputElement.id);
            if (!this.validateRetryPassword()) return this.markInvalid(this.retryPassword_InputElement.id);

            // Disable form interaction and indicate loading state
            this.inputsContainer.style.filter = 'brightness(75%)';
            this.inputsContainer.style.pointerEvents = 'none';

            this.loginButton.toggleAttribute('disabled');
            this.loginButton.innerHTML = '<i class="spinner-border" role="status"></i>';
            this.login().then(alert)
        },

        // Mark a specific input field as invalid
        markInvalid(id) {
            document.getElementById(id).classList.add('is-invalid');
        },

        // Post user login data to database
        async login() {
            const url = `./api/login`;
            const body = JSON.stringify({
                userID: this.userID,
                password: this.password
            });

            const response = await fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: body
            });

            return (await response.json()).response; // Assuming the API returns a JSON response
        }
    };

    // Attach the validateInput method to the login button's click event
    User.loginButton.onclick = () => User.validateInput();
</script>

</html>